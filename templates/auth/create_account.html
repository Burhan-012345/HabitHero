<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Account - HabitHero</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(
          135deg,
          #000000 0%,
          #001a00 100%
        ) !important;
        min-height: 100vh;
        display: flex;
        align-items: center;
        padding: 20px;
      }
      .create-account-card {
        background: #0a0a0a !important;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 0 20px rgba(0, 255, 100, 0.15) !important;
        max-width: 500px;
        margin: 0 auto;
        border: 1px solid #222222 !important;
        position: relative;
        overflow: hidden;
      }
      .create-account-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, #00ff55, transparent);
      }
      .user-info-badge {
        background: linear-gradient(
          135deg,
          #00a040 0%,
          #00ff55 100%
        ) !important;
        color: black;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 25px;
        box-shadow: 0 0 10px rgba(0, 255, 100, 0.3) !important;
        border: 1px solid #00ff55;
      }

      /* Enhanced Password Strength */
      .password-strength {
        height: 6px;
        border-radius: 3px;
        margin-top: 5px;
        background: #222222 !important;
        overflow: hidden;
      }
      .password-strength-bar {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
        background: linear-gradient(90deg, #00ff55, #00a040) !important;
      }

      /* Enhanced Input Fields */
      .form-control {
        background-color: #111111 !important;
        border: 1px solid #333333 !important;
        color: #ffffff !important;
        border-radius: 8px;
        padding: 12px 15px;
        transition: all 0.3s ease;
        font-size: 0.95rem;
      }

      .form-control:focus {
        border-color: #00ff55 !important;
        box-shadow: 0 0 0 2px rgba(0, 255, 100, 0.2) !important;
        background-color: #0a0a0a !important;
        outline: none;
      }

      .form-control.is-valid {
        border-color: #00ff55 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2300ff55' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
      }

      .form-control.is-invalid {
        border-color: #ff5555 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23ff5555'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23ff5555' stroke='none'/%3e%3c/svg%3e");
      }

      .input-group .form-control {
        border-right: none;
      }

      .input-group .btn-outline-secondary {
        border-left: none;
        border-color: #333333;
        background: #111111;
        color: #888;
        transition: all 0.3s ease;
      }

      .input-group .btn-outline-secondary:hover {
        background: #222;
        color: #00ff55;
        border-color: #00ff55;
      }

      /* Text and color updates */
      h2,
      .form-label,
      .form-check-label {
        color: #ffffff !important;
      }

      .text-muted {
        color: #888888 !important;
      }

      .btn-primary {
        background: linear-gradient(135deg, #00a040, #00ff55) !important;
        border: 1px solid #00ff55 !important;
        color: #000000 !important;
        font-weight: 600;
        padding: 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
        width: 100%;
      }

      .btn-primary:hover {
        box-shadow: 0 0 15px rgba(0, 255, 100, 0.3) !important;
        transform: translateY(-1px);
      }

      .btn-outline-secondary {
        background-color: #111111 !important;
        border-color: #444444 !important;
        color: #888888 !important;
      }

      .alert-danger {
        background-color: #220000 !important;
        border-color: #ff5555 !important;
        color: #ffcccc !important;
        border-radius: 8px;
      }

      .text-success {
        color: #00ff55 !important;
      }

      .text-danger {
        color: #ff5555 !important;
      }

      .input-group-text {
        background-color: #222222 !important;
        border-color: #333333 !important;
        color: #888888 !important;
      }

      /* Password requirements */
      .password-requirements {
        background: #111111;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid #222;
      }

      .password-requirements li {
        margin-bottom: 8px;
        padding-left: 25px;
        position: relative;
      }

      .password-requirements li i {
        position: absolute;
        left: 0;
        top: 2px;
      }

      .requirement-met {
        color: #00ff55 !important;
      }

      .requirement-not-met {
        color: #ff5555 !important;
      }

      /* Back links */
      .back-links a {
        color: #888888 !important;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .back-links a:hover {
        color: #00ff55 !important;
      }
    </style>
  </head>
  <body>
    <!-- Rest of the create_account.html content remains the same -->
    <!-- Only the CSS has been updated above -->
    <div class="container">
      <div class="create-account-card">
        <div class="text-center mb-4">
          <img
            src="{{ url_for('static', filename='images/logo.png') }}"
            alt="Logo"
            class="mb-3"
            style="height: 60px"
          />
          <h2>
            <i class="fas fa-user-plus" style="color: #00ff55"></i> Create
            Account
          </h2>
          <p class="text-muted">Complete your account registration</p>
        </div>

        <div class="user-info-badge text-center">
          <h5 class="mb-1">Create New Account</h5>
          <small id="email-display">{{ email }}</small>
        </div>

        <form id="createAccountForm">
          <input type="hidden" id="email" name="email" value="{{ email }}" />

          <!-- Username Input -->
          <div class="mb-3">
            <label for="username" class="form-label">Username *</label>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                id="username"
                name="username"
                required
                autocomplete="username"
                minlength="3"
                maxlength="20"
                pattern="[a-zA-Z0-9_]+"
                oninput="checkUsernameAvailability()"
                placeholder="Choose a unique username"
              />
              <span class="input-group-text">
                <i class="fas fa-user"></i>
              </span>
            </div>
            <div class="mt-1">
              <small id="usernameHelp" class="form-text text-muted">
                Username must be 3-20 characters, letters, numbers, and
                underscores only.
              </small>
            </div>
            <div class="mt-1">
              <small id="usernameAvailabilityMessage" class="d-none"></small>
            </div>
          </div>

          <!-- Password Input -->
          <div class="mb-3">
            <label for="password" class="form-label">Password *</label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="password"
                name="password"
                required
                autocomplete="new-password"
                oninput="checkPasswordStrength()"
                placeholder="Create a strong password"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                id="togglePassword"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="password-strength">
              <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>
          </div>

          <!-- Confirm Password -->
          <div class="mb-4">
            <label for="confirmPassword" class="form-label"
              >Confirm Password *</label
            >
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="confirmPassword"
                name="confirmPassword"
                required
                autocomplete="new-password"
                oninput="checkPasswordMatch()"
                placeholder="Confirm your password"
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                id="toggleConfirmPassword"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="mt-1">
              <small id="passwordMatchMessage" class="d-none"></small>
            </div>
          </div>

          <!-- Password Requirements -->
          <div class="password-requirements mb-4">
            <p class="mb-2"><strong>Password Requirements:</strong></p>
            <ul class="list-unstyled mb-0">
              <li id="req-length">
                <i class="fas fa-circle"></i> At least 8 characters
              </li>
              <li id="req-uppercase">
                <i class="fas fa-circle"></i> One uppercase letter
              </li>
              <li id="req-lowercase">
                <i class="fas fa-circle"></i> One lowercase letter
              </li>
              <li id="req-number"><i class="fas fa-circle"></i> One number</li>
              <li id="req-special">
                <i class="fas fa-circle"></i> One special character
              </li>
            </ul>
          </div>

          <!-- Terms Agreement -->
          <div class="mb-3 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="terms"
              name="terms"
              required
            />
            <label class="form-check-label" for="terms">
              I agree to the
              <a href="{{ url_for('terms') }}" target="_blank"
                >Terms of Service</a
              >
              and
              <a href="{{ url_for('privacy') }}" target="_blank"
                >Privacy Policy</a
              >
            </label>
          </div>

          <!-- Submit Button -->
          <button type="submit" class="btn btn-primary w-100" id="submitBtn">
            <i class="fas fa-user-plus"></i> Create Account
          </button>
        </form>

        <!-- Back Links -->
        <div class="back-links">
          <a href="{{ url_for('login_select', email=email) }}">
            <i class="fas fa-arrow-left"></i> Back to account selection
          </a>
          <a href="{{ url_for('login') }}">
            <i class="fas fa-sign-in-alt"></i> Back to login
          </a>
        </div>

        <div class="alert alert-danger mt-3 d-none" id="errorAlert"></div>
      </div>
    </div>

    <!-- JavaScript remains the same -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const toggleBtns = document.querySelectorAll('[id^="toggle"]');
        const form = document.getElementById("createAccountForm");
        const submitBtn = document.getElementById("submitBtn");
        const errorAlert = document.getElementById("errorAlert");
        const usernameInput = document.getElementById("username");
        const emailInput = document.getElementById("email");

        // Variables to track validation state
        let isUsernameAvailable = false;
        let isUsernameValid = false;

        /* -------------------------------
           Toggle password visibility
        -------------------------------- */
        toggleBtns.forEach((btn) => {
          btn.addEventListener("click", function () {
            const targetId =
              this.id === "togglePassword" ? "password" : "confirmPassword";
            const input = document.getElementById(targetId);
            const type = input.type === "password" ? "text" : "password";
            input.type = type;

            this.innerHTML =
              type === "password"
                ? '<i class="fas fa-eye"></i>'
                : '<i class="fas fa-eye-slash"></i>';
          });
        });

        /* -------------------------------
           Username validation
        -------------------------------- */
        usernameInput.addEventListener("blur", function () {
          checkUsernameAvailability();
        });

        /* -------------------------------
           Form submit
        -------------------------------- */
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          hideError();

          const username = usernameInput.value.trim();
          const password = document.getElementById("password").value.trim();
          const confirmPassword = document
            .getElementById("confirmPassword")
            .value.trim();
          const terms = document.getElementById("terms").checked;
          const email = emailInput.value.trim();

          // Validate username
          if (!username) {
            return showError("Username is required.");
          }

          if (!isUsernameValid) {
            return showError(
              "Username must be 3-20 characters, letters, numbers, and underscores only."
            );
          }

          if (!isUsernameAvailable) {
            return showError("Please choose an available username.");
          }

          // Validate password
          if (!terms) {
            return showError("You must agree to the terms and conditions.");
          }

          if (password !== confirmPassword) {
            return showError("Passwords do not match.");
          }

          const requirements = checkPasswordRequirements(password);
          if (!requirements.met) {
            return showError("Password does not meet all requirements.");
          }

          // Check username availability one more time before submission
          const finalCheck = await checkUsernameAvailability(true);
          if (!finalCheck.available) {
            return showError(
              "Username is no longer available. Please choose another one."
            );
          }

          submitBtn.disabled = true;
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Creating Account...';

          try {
            const response = await fetch("{{ url_for('create_account') }}", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                email: email,
                username: username,
                password: password,
              }),
            });

            const data = await response.json();

            if (data.success) {
              // Redirect to login page
              window.location.href = data.redirect;
            } else {
              showError(data.message || "Failed to create account.");
              resetButton();
            }
          } catch (err) {
            console.error("Error:", err);
            showError("Network error. Please try again.");
            resetButton();
          }
        });

        /* -------------------------------
           Helper Functions
        -------------------------------- */
        async function checkUsernameAvailability(finalCheck = false) {
          const username = usernameInput.value.trim();
          const messageElement = document.getElementById(
            "usernameAvailabilityMessage"
          );

          // Clear previous message
          messageElement.classList.add("d-none");
          usernameInput.classList.remove("is-valid", "is-invalid");

          // Check if username is empty
          if (!username) {
            isUsernameValid = false;
            isUsernameAvailable = false;
            return { valid: false, available: false };
          }

          // Validate username format
          const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
          if (!usernameRegex.test(username)) {
            messageElement.textContent =
              "Username must be 3-20 characters, letters, numbers, and underscores only.";
            messageElement.className = "text-danger";
            messageElement.classList.remove("d-none");
            usernameInput.classList.add("is-invalid");
            isUsernameValid = false;
            isUsernameAvailable = false;
            return { valid: false, available: false };
          }

          isUsernameValid = true;

          // Check username availability via API
          try {
            const response = await fetch(
              "{{ url_for('check_username_availability') }}",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: username }),
              }
            );

            const data = await response.json();

            if (data.available) {
              if (!finalCheck) {
                messageElement.textContent = "✓ Username is available!";
                messageElement.className = "text-success";
                messageElement.classList.remove("d-none");
                usernameInput.classList.add("is-valid");
              }
              isUsernameAvailable = true;
              return { valid: true, available: true };
            } else {
              if (!finalCheck) {
                messageElement.textContent =
                  "✗ Username is already taken. Please choose another.";
                messageElement.className = "text-danger";
                messageElement.classList.remove("d-none");
                usernameInput.classList.add("is-invalid");
              }
              isUsernameAvailable = false;
              return { valid: true, available: false };
            }
          } catch (error) {
            console.error("Error checking username:", error);
            if (!finalCheck) {
              messageElement.textContent =
                "Unable to check username availability. Please try again.";
              messageElement.className = "text-danger";
              messageElement.classList.remove("d-none");
            }
            isUsernameAvailable = false;
            return { valid: true, available: false };
          }
        }

        function showError(message) {
          errorAlert.textContent = message;
          errorAlert.classList.remove("d-none");
          // Scroll to error
          errorAlert.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }

        function hideError() {
          errorAlert.classList.add("d-none");
          errorAlert.textContent = "";
        }

        function resetButton() {
          submitBtn.disabled = false;
          submitBtn.innerHTML =
            '<i class="fas fa-user-plus"></i> Create Account';
        }

        // Initialize password strength functions
        function checkPasswordStrength() {
          const password = document.getElementById("password").value;
          const strengthBar = document.getElementById("passwordStrengthBar");

          if (!strengthBar) return;

          // Calculate strength
          let strength = 0;
          if (password.length >= 8) strength += 20;
          if (/[A-Z]/.test(password)) strength += 20;
          if (/[a-z]/.test(password)) strength += 20;
          if (/\d/.test(password)) strength += 20;
          if (/[!@#$%^&*()\-_=+[\]{}|;:'",.<>/?]/.test(password))
            strength += 20;

          // Update strength bar
          strengthBar.style.width = strength + "%";

          // Update color
          if (strength <= 40) {
            strengthBar.style.backgroundColor = "#ff5555";
          } else if (strength <= 80) {
            strengthBar.style.backgroundColor = "#ffaa00";
          } else {
            strengthBar.style.backgroundColor = "#00ff55";
          }

          // Update requirements UI
          checkPasswordRequirements(password);
        }

        function checkPasswordMatch() {
          const password = document.getElementById("password").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;
          const message = document.getElementById("passwordMatchMessage");

          if (!message) return;

          if (!password || !confirmPassword) {
            message.classList.add("d-none");
            return;
          }

          if (password === confirmPassword) {
            message.textContent = "✓ Passwords match!";
            message.className = "text-success";
            message.classList.remove("d-none");
          } else {
            message.textContent = "✗ Passwords do not match";
            message.className = "text-danger";
            message.classList.remove("d-none");
          }
        }
      });

      /* -------------------------------
         Password validation helpers
      -------------------------------- */
      function checkPasswordRequirements(password) {
        const rules = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /\d/.test(password),
          special: /[!@#$%^&*()\-_=+[\]{}|;:'",.<>/?]/.test(password),
        };

        updateRequirementUI("req-length", rules.length);
        updateRequirementUI("req-uppercase", rules.uppercase);
        updateRequirementUI("req-lowercase", rules.lowercase);
        updateRequirementUI("req-number", rules.number);
        updateRequirementUI("req-special", rules.special);

        return {
          ...rules,
          met: Object.values(rules).every(Boolean),
        };
      }

      function updateRequirementUI(id, met) {
        const el = document.getElementById(id);
        if (!el) return;

        el.classList.toggle("requirement-met", met);
        el.classList.toggle("requirement-not-met", !met);

        const icon = el.querySelector("i");
        icon.className = met ? "fas fa-check-circle" : "fas fa-times-circle";
      }
    </script>
  </body>
</html>
