{% extends "base.html" %} {% block title %}Reset Password - HabitHero{% endblock
%} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/auth.css') }}"
/>
<style>
  /* Custom styles for reset password page */
  .snap-modal {
    background-color: #000000 !important;
    border: 1px solid #00bfff !important;
    box-shadow: 0 0 10px rgba(0, 191, 255, 0.3) !important;
    color: #ffffff !important;
  }

  .strength-meter-fill {
    background: linear-gradient(90deg, #00bfff, #0066cc) !important;
    box-shadow: 0 0 5px rgba(0, 191, 255, 0.5) !important;
  }

  .strength-weak {
    width: 20%;
    background: linear-gradient(90deg, #ff0000, #cc0000) !important;
  }
  .strength-medium {
    width: 60%;
    background: linear-gradient(90deg, #ffff00, #ff9900) !important;
  }
  .strength-strong {
    width: 100%;
    background: linear-gradient(90deg, #00ff00, #00cc00) !important;
  }

  .btn-primary {
    background: linear-gradient(135deg, #0066cc, #00bfff) !important;
    border: 1px solid #00bfff !important;
    color: #ffffff !important;
    box-shadow: 0 0 8px rgba(0, 191, 255, 0.4) !important;
  }

  .btn-primary:hover {
    box-shadow: 0 0 12px rgba(0, 191, 255, 0.6) !important;
  }

  .form-control {
    background-color: #111111 !important;
    border: 1px solid #333333 !important;
    color: #ffffff !important;
  }

  .form-control:focus {
    border-color: #00bfff !important;
    box-shadow: 0 0 5px rgba(0, 191, 255, 0.3) !important;
  }

  .password-rules {
    background-color: #111111 !important;
    border: 1px solid #333333 !important;
    color: #ffffff !important;
  }

  .rule-valid {
    color: #00ff00 !important;
  }

  .rule-invalid {
    color: #ff0000 !important;
  }
</style>
{% endblock %} {% block content %}
<div class="auth-container">
  <div class="auth-card">
    <div class="logo">
      <img
        src="{{ url_for('static', filename='images/logo.png') }}"
        alt="Logo"
        class="auth-logo"
      />
      <p>Reset Your Password</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %} {% endif %} {% endwith %}

    <form method="POST" action="{{ url_for('reset_password', token=token) }}">
      <div class="form-group password-toggle">
        <label for="password">New Password</label>
        <input
          type="password"
          id="password"
          name="password"
          class="form-control"
          required
        />
        <button
          type="button"
          class="toggle-icon"
          onclick="togglePassword('password', this)"
        >
          <i class="fas fa-eye"></i>
        </button>

        <div class="password-strength">
          <div class="strength-meter">
            <div id="strength-meter-fill" class="strength-meter-fill"></div>
          </div>
        </div>

        <a href="#" id="toggle-rules" class="small">
          <i class="fas fa-chevron-down"></i> Show password instructions
        </a>

        <div id="password-rules" class="password-rules" style="display: none">
          <p class="small mb-2">Password must contain:</p>
          <ul>
            <li id="rule-length">
              <i class="fas fa-times-circle"></i> At least 8 characters
            </li>
            <li id="rule-uppercase">
              <i class="fas fa-times-circle"></i> One uppercase letter
            </li>
            <li id="rule-lowercase">
              <i class="fas fa-times-circle"></i> One lowercase letter
            </li>
            <li id="rule-number">
              <i class="fas fa-times-circle"></i> One number
            </li>
            <li id="rule-special">
              <i class="fas fa-times-circle"></i> One special character
            </li>
          </ul>
        </div>
      </div>

      <div class="form-group password-toggle">
        <label for="confirm_password">Confirm New Password</label>
        <input
          type="password"
          id="confirm_password"
          name="confirm_password"
          class="form-control"
          required
        />
        <button
          type="button"
          class="toggle-icon"
          onclick="togglePassword('confirm_password', this)"
        >
          <i class="fas fa-eye"></i>
        </button>
        <div
          id="confirm-password-error"
          class="text-danger small mt-1"
          style="display: none"
        ></div>
      </div>

      <div class="form-group">
        <button
          type="submit"
          id="reset-btn"
          class="btn btn-primary btn-block"
          disabled
        >
          Reset Password
        </button>
      </div>
    </form>

    <div class="text-center mt-3">
      <a href="{{ url_for('login') }}" class="small">Back to login</a>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/auth.js') }}" defer></script>

<script>
  function togglePassword(fieldId, buttonElement) {
    const input = document.getElementById(fieldId);
    const icon = buttonElement.querySelector("i");

    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }

  function updateRule(element, isValid) {
    // Check if element exists before trying to update it
    if (!element) return;

    if (isValid) {
      element.classList.add("rule-valid");
      element.classList.remove("rule-invalid");
      element.innerHTML =
        '<i class="fas fa-check-circle"></i> ' +
        element.textContent.replace(/[✓✗]\s*/, "");
    } else {
      element.classList.add("rule-invalid");
      element.classList.remove("rule-valid");
      element.innerHTML =
        '<i class="fas fa-times-circle"></i> ' +
        element.textContent.replace(/[✓✗]\s*/, "");
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirm_password");
    const resetBtn = document.getElementById("reset-btn");
    const toggleRules = document.getElementById("toggle-rules");
    const rulesPanel = document.getElementById("password-rules");

    // Password validation
    function validatePassword() {
      const password = passwordInput.value;

      // Get rule elements - check if they exist first
      const rules = {
        length: document.getElementById("rule-length"),
        uppercase: document.getElementById("rule-uppercase"),
        lowercase: document.getElementById("rule-lowercase"),
        number: document.getElementById("rule-number"),
        special: document.getElementById("rule-special"),
      };

      // Check rules
      const hasLength = password.length >= 8;
      const hasUppercase = /[A-Z]/.test(password);
      const hasLowercase = /[a-z]/.test(password);
      const hasNumber = /\d/.test(password);
      const hasSpecial = /[!@#$%^&*()\-_=+\[\]{}|;:,.<>?/]/.test(password);

      // Update rule indicators if elements exist
      updateRule(rules.length, hasLength);
      updateRule(rules.uppercase, hasUppercase);
      updateRule(rules.lowercase, hasLowercase);
      updateRule(rules.number, hasNumber);
      updateRule(rules.special, hasSpecial);

      // Calculate strength
      let strength = 0;
      if (hasLength) strength++;
      if (hasUppercase) strength++;
      if (hasLowercase) strength++;
      if (hasNumber) strength++;
      if (hasSpecial) strength++;

      // Update strength meter if it exists
      const strengthMeter = document.getElementById("strength-meter-fill");
      if (strengthMeter) {
        strengthMeter.className = "strength-meter-fill";
        if (strength <= 2) {
          strengthMeter.classList.add("strength-weak");
        } else if (strength <= 4) {
          strengthMeter.classList.add("strength-medium");
        } else {
          strengthMeter.classList.add("strength-strong");
        }
      }

      // Check if all rules pass
      const allValid =
        hasLength && hasUppercase && hasLowercase && hasNumber && hasSpecial;
      const passwordsMatch = confirmInput.value === password;

      if (resetBtn) {
        resetBtn.disabled = !(allValid && passwordsMatch);
      }
    }

    function validateConfirmPassword() {
      const password = passwordInput.value;
      const confirmPassword = confirmInput.value;
      const errorElement = document.getElementById("confirm-password-error");

      if (password !== confirmPassword) {
        if (errorElement) {
          errorElement.textContent = "Passwords do not match";
          errorElement.style.display = "block";
        }
        if (resetBtn) {
          resetBtn.disabled = true;
        }
      } else {
        if (errorElement) {
          errorElement.style.display = "none";
        }
        // Re-enable if password is valid
        validatePassword();
      }
    }

    // Event listeners - only if elements exist
    if (passwordInput) {
      passwordInput.addEventListener("input", validatePassword);
    }

    if (confirmInput) {
      confirmInput.addEventListener("input", validateConfirmPassword);
    }

    // Toggle rules panel - only if it exists
    if (toggleRules && rulesPanel) {
      toggleRules.addEventListener("click", function (e) {
        e.preventDefault();
        const icon = this.querySelector("i");

        if (
          rulesPanel.style.display === "none" ||
          rulesPanel.style.display === ""
        ) {
          rulesPanel.style.display = "block";
          icon.classList.remove("fa-chevron-down");
          icon.classList.add("fa-chevron-up");
          this.innerHTML =
            '<i class="fas fa-chevron-up"></i> Hide password instructions';
        } else {
          rulesPanel.style.display = "none";
          icon.classList.remove("fa-chevron-up");
          icon.classList.add("fa-chevron-down");
          this.innerHTML =
            '<i class="fas fa-chevron-down"></i> Show password instructions';
        }
      });
    }
  });
</script>
{% endblock %}
