{% extends "base.html" %} {% block title %}Forgot Password - HabitHero{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/auth.css') }}"
/>
<style>
  .account-select {
    margin-bottom: 20px;
  }
  .account-option {
    padding: 12px 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
  }
  .account-option:hover {
    background-color: #f8f9fa;
    border-color: #667eea;
  }
  .account-option.active {
    background-color: #667eea15;
    border-color: #667eea;
  }
  .account-avatar-small {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    margin-right: 15px;
    flex-shrink: 0;
  }
  .account-info-small h6 {
    margin: 0;
    font-size: 1rem;
  }
  .account-info-small p {
    margin: 2px 0 0 0;
    font-size: 0.85rem;
    color: #6c757d;
  }
  .note-box {
    background-color: rgba(0, 180, 255, 0.1);
    border-left: 4px solid #00b4ff;
    padding: 12px 15px;
    margin-bottom: 20px;
    border-radius: 5px;
    font-size: 0.9rem;
    color: #ffffff;
  }
</style>
{% endblock %} {% block content %}
<div class="auth-container">
  <div class="auth-card">
    <div class="logo">
      <img
        src="{{ url_for('static', filename='images/logo.png') }}"
        alt="Logo"
        class="auth-logo"
      />
      <p>
        {% if accounts and accounts|length > 1 %} Select which account to reset
        {% elif accounts and accounts|length == 1 %} Reset password for {{
        accounts[0].username }} {% else %} Enter your email to reset password {%
        endif %}
      </p>
    </div>

    {% if accounts and accounts|length > 1 %}
    <div class="note-box">
      <i class="fas fa-info-circle text-primary"></i>
      You have multiple accounts with this email. Please select which account
      you want to reset the password for.
    </div>
    {% endif %}

    <form
      method="POST"
      action="{{ url_for('forgot_password') }}"
      id="resetForm"
    >
      <div class="form-group">
        <label for="email">Email Address</label>
        <input
          type="email"
          id="email"
          name="email"
          class="form-control"
          value="{{ email }}"
          required
          {%
          if
          accounts
          %}readonly{%
          endif
          %}
        />
        {% if not accounts %}
        <small class="text-muted">
          Enter your email address first. If you have multiple accounts, you'll
          be able to select which one.
        </small>
        {% endif %}
      </div>

      {% if accounts and accounts|length > 1 %}
      <div class="form-group account-select">
        <label>Select Account</label>
        {% for account in accounts %}
        <div
          class="account-option"
          onclick="selectAccount({{ account.id }}, '{{ account.username }}')"
          id="account-{{ account.id }}"
        >
          <div class="account-avatar-small">
            {{ account.username[0]|upper }}
          </div>
          <div class="account-info-small">
            <h6>{{ account.username }}</h6>
            <p>Created {{ account.created_at.strftime('%b %d, %Y') }}</p>
          </div>
        </div>
        {% endfor %}
        <input type="hidden" name="username" id="selectedUsername" />
      </div>
      {% elif accounts and accounts|length == 1 %}
      <input type="hidden" name="username" value="{{ accounts[0].username }}" />
      <input type="hidden" name="account_id" value="{{ accounts[0].id }}" />
      <div class="account-option active" style="cursor: default">
        <div class="account-avatar-small">
          {{ accounts[0].username[0]|upper }}
        </div>
        <div class="account-info-small">
          <h6>{{ accounts[0].username }}</h6>
          <p>Created {{ accounts[0].created_at.strftime('%b %d, %Y') }}</p>
        </div>
      </div>
      {% endif %}

      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
          {% if accounts and accounts|length > 1 %} Send Reset Link to Selected
          Account {% elif accounts and accounts|length == 1 %} Send Reset Link
          to {{ accounts[0].username }} {% else %} Continue {% endif %}
        </button>
      </div>
    </form>

    <div class="text-center mt-3">
      <a href="{{ url_for('login') }}" class="small">
        <i class="fas fa-arrow-left"></i> Back to login
      </a>
    </div>
  </div>
</div>

<!-- Replace the entire script section with this: -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('resetForm');
      const emailInput = document.getElementById('email');
      const submitBtn = document.getElementById('submitBtn');

      // If email is entered but no accounts shown yet
      if (emailInput.value && !{{ accounts|length if accounts else 0 }}) {
          // Auto-submit to show accounts
          form.submit();
      }

      // Handle account selection for multiple accounts
      {% if accounts and accounts|length > 1 %}
      let selectedAccountId = null;
      let selectedUsername = null;

      function selectAccount(accountId, username) {
          // Remove active class from all accounts
          document.querySelectorAll('.account-option').forEach(option => {
              option.classList.remove('active');
          });

          // Add active class to selected account
          const selectedOption = document.getElementById('account-' + accountId);
          selectedOption.classList.add('active');

          // Store selection
          selectedAccountId = accountId;
          selectedUsername = username;

          // Update hidden input for username (optional)
          document.getElementById('selectedUsername').value = username;

          // Add or update hidden input for account ID
          let accountIdInput = document.getElementById('selectedAccountId');
          if (!accountIdInput) {
              accountIdInput = document.createElement('input');
              accountIdInput.type = 'hidden';
              accountIdInput.name = 'account_id';
              accountIdInput.id = 'selectedAccountId';
              form.appendChild(accountIdInput);
          }
          accountIdInput.value = accountId;

          // Enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Send Reset Link to ' + username;
      }

      // Initialize: disable submit button, no auto-select
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Select an account above';

      // Add click listeners to all account options
      document.querySelectorAll('.account-option').forEach(option => {
          option.addEventListener('click', function() {
              const accountId = this.id.replace('account-', '');
              const username = this.querySelector('h6').textContent;
              selectAccount(accountId, username);
          });
      });

      // Prevent form submission if no account selected
      form.addEventListener('submit', function(e) {
          if (!selectedAccountId) {
              e.preventDefault();
              alert('Please select an account first.');
              return false;
          }
      });
      {% elif accounts and accounts|length == 1 %}
      // For single account, focus on submit button
      submitBtn.focus();
      {% elif not accounts %}
      // No accounts yet, focus on email input
      emailInput.focus();
      {% endif %}
  });
</script>
{% endblock %}
